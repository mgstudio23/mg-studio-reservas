<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - MG STUDIO</title>
    <style>
        :root {
            --primary: #ff4b7d;
            --primary-light: #ff85a2;
            --primary-dark: #e62a5d;
            --secondary: #333333;
            --light: #ffffff;
            --gray-light: #f8f8f8;
            --gray: #eaeaea;
            --text: #333333;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: var(--text);
            line-height: 1.6;
        }
        
        .admin-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: none; /* Se mostrar√° despu√©s de autenticar */
        }
        
        .admin-header {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: var(--light);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .admin-header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .view-site {
            background-color: white;
            color: var(--primary);
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .view-site:hover {
            background-color: rgba(255,255,255,0.8);
        }
        
        .admin-panel {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        
        .admin-sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .admin-menu {
            list-style: none;
        }
        
        .admin-menu-item {
            margin-bottom: 10px;
        }
        
        .admin-menu-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text);
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .admin-menu-link:hover {
            background-color: var(--gray-light);
        }
        
        .admin-menu-link.active {
            background-color: var(--primary-light);
            color: white;
        }
        
        .admin-menu-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .admin-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .admin-content.active {
            display: block;
        }
        
        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray);
        }
        
        .admin-section-header h2 {
            font-size: 20px;
            color: var(--text);
        }
        
        .admin-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .admin-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }
        
        .admin-card-title {
            font-size: 14px;
            color: #777;
            margin-bottom: 10px;
        }
        
        .admin-card-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .admin-card-footer {
            font-size: 14px;
            color: #999;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        
        .admin-tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: bold;
        }
        
        .admin-search {
            display: flex;
            margin-bottom: 20px;
        }
        
        .admin-search input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--gray);
            border-radius: 5px 0 0 5px;
            font-size: 14px;
        }
        
        .admin-search button {
            padding: 10px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th {
            background-color: var(--gray-light);
            padding: 12px 15px;
            text-align: left;
            font-weight: bold;
        }
        
        .admin-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        .admin-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .admin-badge-pending {
            background-color: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }
        
        .admin-badge-confirmed {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .admin-badge-canceled {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .admin-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .admin-action-edit {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .admin-action-confirm {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .admin-action-cancel {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .admin-action-whatsapp {
            background-color: rgba(37, 211, 102, 0.2);
            color: #25d366;
        }
        
        .admin-empty-state {
            text-align: center;
            padding: 50px 0;
            color: #999;
        }
        
        .admin-empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--gray);
        }
        
        .admin-empty-state-text {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .admin-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .admin-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .admin-modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .admin-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray);
        }
        
        .admin-modal-title {
            font-size: 20px;
            color: var(--text);
            margin: 0;
        }
        
        .admin-modal-close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .admin-form-group {
            margin-bottom: 15px;
        }
        
        .admin-form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .admin-form-input, .admin-form-select, .admin-form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray);
            border-radius: 5px;
            font-size: 16px;
        }
        
        .admin-form-textarea {
            height: 100px;
            resize: vertical;
        }
        
        .admin-form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Estilos adicionales para gesti√≥n de disponibilidad */
        .admin-content-box {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-content-box h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid var(--gray);
            padding-bottom: 8px;
        }

        .admin-calendar {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }

        .admin-calendar h3 {
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .month-nav button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 18px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .availability-day {
            background-color: var(--gray-light);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .availability-day-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }

        .availability-day-date {
            font-weight: bold;
            font-size: 16px;
        }

        .availability-times {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .availability-time {
            background-color: white;
            border-radius: 5px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--gray);
            width: calc(50% - 5px);
        }

        .availability-time-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .availability-time-actions {
            display: flex;
            gap: 5px;
        }

        .availability-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-high {
            background-color: #4CAF50;
        }

        .status-medium {
            background-color: #FF9800;
        }

        .status-low {
            background-color: #F44336;
        }

        .status-unavailable {
            background-color: #9E9E9E;
        }
        
        /* Estilos para promociones */
        .promo-card {
            background-color: var(--gray-light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .promo-info {
            flex: 1;
        }
        
        .promo-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .promo-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .promo-discount {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .promo-actions {
            display: flex;
            gap: 5px;
        }
        
        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        
        @media (max-width: 768px) {
            .admin-panel {
                grid-template-columns: 1fr;
            }
            
            .admin-sidebar {
                margin-bottom: 20px;
            }
            
            .admin-cards {
                grid-template-columns: 1fr;
            }
            
            .availability-time {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>MG STUDIO - Panel de Administraci√≥n</h1>
            <a href="index.html" class="view-site">Ver Sitio</a>
        </div>
        
        <div class="admin-panel">
            <div class="admin-sidebar">
                <ul class="admin-menu">
                    <li class="admin-menu-item">
                        <a href="#" class="admin-menu-link active" onclick="showSection('dashboard')">
                            <span class="admin-menu-icon">üìä</span> Dashboard
                        </a>
                    </li>
                    <li class="admin-menu-item">
                        <a href="#" class="admin-menu-link" onclick="showSection('appointments')">
                            <span class="admin-menu-icon">üìÖ</span> Citas
                        </a>
                    </li>
                    <li class="admin-menu-item">
                        <a href="#" class="admin-menu-link" onclick="showSection('clients')">
                            <span class="admin-menu-icon">üë•</span> Clientes
                        </a>
                    </li>
                    <li class="admin-menu-item">
                        <a href="#" class="admin-menu-link" onclick="showSection('services')">
                            <span class="admin-menu-icon">üíÑ</span> Servicios
                        </a>
                    </li>
                    <li class="admin-menu-item">
                        <a href="#" class="admin-menu-link" onclick="showSection('promotions')">
                            <span class="admin-menu-icon">üì¢</span> Promociones
                        </a>
                    </li>
                    <li class="admin-menu-item">
                        <a href="#" class="admin-menu-link" onclick="showSection('settings')">
                            <span class="admin-menu-icon">‚öôÔ∏è</span> Configuraci√≥n
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- DASHBOARD SECTION -->
            <div id="dashboard" class="admin-content active">
                <div class="admin-section-header">
                    <h2>Dashboard</h2>
                    <div id="current-date">Hoy: --/--/----</div>
                </div>
                
                <div class="admin-cards">
                    <div class="admin-card">
                        <div class="admin-card-title">Citas de Hoy</div>
                        <div class="admin-card-value" id="today-counter">0</div>
                        <div class="admin-card-footer">Citas programadas</div>
                    </div>
                    
                    <div class="admin-card">
                        <div class="admin-card-title">Citas Pendientes</div>
                        <div class="admin-card-value" id="pending-counter">0</div>
                        <div class="admin-card-footer">Por confirmar</div>
                    </div>
                    
                    <div class="admin-card">
                        <div class="admin-card-title">Clientes Totales</div>
                        <div class="admin-card-value" id="clients-counter">0</div>
                        <div class="admin-card-footer">En la base de datos</div>
                    </div>
                    
                    <div class="admin-card">
                        <div class="admin-card-title">Ingresos (Mes)</div>
                        <div class="admin-card-value" id="income-counter">s/0</div>
                        <div class="admin-card-footer">Acumulado</div>
                    </div>
                </div>
                
                <div class="admin-tabs">
                    <div class="admin-tab active" onclick="showTab('recent')">Citas Recientes</div>
                    <div class="admin-tab" onclick="showTab('pending')">Por Confirmar</div>
                    <div class="admin-tab" onclick="showTab('today')">Hoy</div>
                </div>
                
                <div class="admin-search">
                    <input type="text" id="search-input" placeholder="Buscar por nombre, servicio...">
                    <button onclick="searchAppointments()">üîç</button>
                </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-table">
                        <!-- Las reservas se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
            
            <!-- APPOINTMENTS SECTION -->
            <div id="appointments" class="admin-content">
                <div class="admin-section-header">
                    <h2>Gesti√≥n de Citas</h2>
                    <button class="admin-button" onclick="openNewAppointmentModal()">+ Nueva Cita</button>
                </div>
                
                <div class="admin-search">
                    <input type="text" id="appointments-search" placeholder="Buscar cita...">
                    <button onclick="searchAppointmentsData()">üîç</button>
                </div>
                
                <div class="admin-tabs">
                    <div class="admin-tab active" onclick="filterAppointments('all')">Todas</div>
                    <div class="admin-tab" onclick="filterAppointments('pending')">Pendientes</div>
                    <div class="admin-tab" onclick="filterAppointments('confirmed')">Confirmadas</div>
                    <div class="admin-tab" onclick="filterAppointments('canceled')">Canceladas</div>
                    <div class="admin-tab" onclick="showAvailabilitySection()">Disponibilidad</div>
                </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-data-table">
                        <!-- Las reservas se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
                
                <!-- Secci√≥n de Disponibilidad (inicialmente oculta) -->
                <div id="availability-section" style="display: none;">
                    <div class="admin-section-header">
                        <h2>Gesti√≥n de Disponibilidad</h2>
                        <button class="admin-button" onclick="openNewAvailabilityModal()">+ Nuevo Horario</button>
                    </div>
                    
                    <div class="admin-calendar">
                        <h3>
                            <div class="month-nav">
                                <button id="prevMonthAdmin" onclick="changeAdminMonth(-1)">‚Üê</button>
                                <span id="currentMonthLabel">Mayo 2025</span>
                                <button id="nextMonthAdmin" onclick="changeAdminMonth(1)">‚Üí</button>
                            </div>
                        </h3>
                    </div>
                    
                    <div class="admin-content-box">
                        <h3>D√≠as con Horarios Disponibles</h3>
                        <div id="availability-list">
                            <!-- Los d√≠as disponibles se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CLIENTS SECTION -->
            <div id="clients" class="admin-content">
                <div class="admin-section-header">
                    <h2>Gesti√≥n de Clientes</h2>
                    <button class="admin-button" onclick="openNewClientModal()">+ Nuevo Cliente</button>
                </div>
                
                <div class="admin-search">
                    <input type="text" id="clients-search" placeholder="Buscar cliente...">
                    <button onclick="searchClients()">üîç</button>
                </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tel√©fono</th>
                            <th>√öltima Visita</th>
                            <th>Total Citas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table">
                        <!-- Los clientes se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
            
            <!-- SERVICES SECTION -->
            <div id="services" class="admin-content">
                <div class="admin-section-header">
                    <h2>Gesti√≥n de Servicios</h2>
                    <button class="admin-button" onclick="openNewServiceModal()">+ Nuevo Servicio</button>
                </div>
                
                <div class="admin-search">
                    <input type="text" id="services-search" placeholder="Buscar servicio...">
                    <button onclick="searchServices()">üîç</button>
                </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Servicio</th>
                            <th>Categor√≠a</th>
                            <th>Duraci√≥n</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="services-table">
                        <!-- Los servicios se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
            
            <!-- PROMOTIONS SECTION -->
            <div id="promotions" class="admin-content">
                <div class="admin-section-header">
                    <h2>Gesti√≥n de Promociones</h2>
                    <button class="admin-button" onclick="openNewPromotionModal()">+ Nueva Promoci√≥n</button>
                </div>
                
                <div class="admin-search">
                    <input type="text" id="promotions-search" placeholder="Buscar promoci√≥n...">
                    <button onclick="searchPromotions()">üîç</button>
                </div>
                
                <div id="promotions-container">
                    <!-- Las promociones se cargar√°n aqu√≠ -->
                </div>
            </div>
            
            <!-- SETTINGS SECTION -->
            <div id="settings" class="admin-content">
                <div class="admin-section-header">
                    <h2>Configuraci√≥n</h2>
                </div>
                
                <div class="admin-content-box">
                    <h3>Informaci√≥n del Negocio</h3>
                    
                    <div class="admin-form-group">
                        <label class="admin-form-label">Nombre del Estudio:</label>
                        <input type="text" id="settings-name" class="admin-form-input" value="MG STUDIO">
                    </div>
                    
                    <div class="admin-form-group">
                        <label class="admin-form-label">Direcci√≥n:</label>
                        <input type="text" id="settings-address" class="admin-form-input" value="Jr. Bolognesi 265">
                    </div>
                    
                    <div class="admin-form-group">
                        <label class="admin-form-label">Tel√©fono:</label>
                        <input type="text" id="settings-phone" class="admin-form-input" value="995 904 351">
                    </div>
                    
                    <div class="admin-form-group">
                        <label class="admin-form-label">Instagram:</label>
                        <input type="text" id="settings-instagram" class="admin-form-input" value="https://www.instagram.com/mg.studio_pe">
                    </div>
                </div>
                
                <div class="admin-content-box">
                    <h3>Personalizaci√≥n</h3>
                    
                    <div class="admin-form-group">
                        <label class="admin-form-label">Color Principal:</label>
                        <div style="display: flex; align-items: center;">
                            <div class="color-preview" id="primaryColorPreview" style="background-color: #ff4b7d;"></div>
                            <input type="text" id="settings-primary-color" class="admin-form-input" value="#ff4b7d">
                        </div>
                    </div>
                    
                    <div class="admin-form-group">
                        <label class="admin-form-label">Color Secundario:</label>
                        <div style="display: flex; align-items: center;">
                            <div class="color-preview" id="secondaryColorPreview" style="background-color: #333333;"></div>
                            <input type="text" id="settings-secondary-color" class="admin-form-input" value="#333333">
                        </div>
                    </div>
                </div>
                
                <div class="admin-form-buttons">
                    <button class="admin-button" style="background-color: #ccc; color: black;">Cancelar</button>
                    <button class="admin-button" onclick="saveSettings()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALES PARA GESTI√ìN DE CITAS -->
    
    <!-- Modal para editar cita -->
    <div id="edit-appointment-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Editar Cita</h3>
                <span class="admin-modal-close" onclick="closeEditModal()">&times;</span>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Cliente:</label>
                <input type="text" id="edit-client-name" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Tel√©fono:</label>
                <input type="text" id="edit-client-phone" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Servicio:</label>
                <select id="edit-service" class="admin-form-select">
                    <option>Lifting de Pesta√±as</option>
                    <option>Extensiones Cl√°sicas</option>
                    <option>Efecto R√≠mel</option>
                    <option>Laminado de cejas</option>
                    <option>Visagismo</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Fecha:</label>
                <input type="date" id="edit-date" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Hora:</label>
                <select id="edit-time" class="admin-form-select">
                    <option>9:00 AM</option>
                    <option>11:00 AM</option>
                    <option>2:00 PM</option>
                    <option>5:00 PM</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Estado:</label>
                <select id="edit-status" class="admin-form-select">
                    <option value="pending">Pendiente</option>
                    <option value="confirmed">Confirmado</option>
                    <option value="canceled">Cancelado</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Observaciones:</label>
                <textarea id="edit-notes" class="admin-form-textarea"></textarea>
            </div>
            
            <div class="admin-form-buttons">
                <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeEditModal()">Cancelar</button>
                <button class="admin-button" onclick="saveAppointment()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para nueva cita -->
    <div id="new-appointment-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Nueva Cita</h3>
                <span class="admin-modal-close" onclick="closeNewAppointmentModal()">&times;</span>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Cliente:</label>
                <input type="text" id="new-client-name" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Tel√©fono:</label>
                <input type="text" id="new-client-phone" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Servicio:</label>
                <select id="new-service" class="admin-form-select">
                    <option>Lifting de Pesta√±as</option>
                    <option>Extensiones Cl√°sicas</option>
                    <option>Efecto R√≠mel</option>
                    <option>Laminado de cejas</option>
                    <option>Visagismo</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Fecha:</label>
                <input type="date" id="new-date" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Hora:</label>
                <select id="new-time" class="admin-form-select">
                    <option>9:00 AM</option>
                    <option>11:00 AM</option>
                    <option>2:00 PM</option>
                    <option>5:00 PM</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Estado:</label>
                <select id="new-status" class="admin-form-select">
                    <option value="pending">Pendiente</option>
                    <option value="confirmed">Confirmado</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Observaciones:</label>
                <textarea id="new-notes" class="admin-form-textarea"></textarea>
            </div>
            
            <div class="admin-form-buttons">
                <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeNewAppointmentModal()">Cancelar</button>
                <button class="admin-button" onclick="createAppointment()">Crear Cita</button>
            </div>
        </div>
    </div>
    
    <!-- MODALES PARA GESTI√ìN DE CLIENTES -->
    
    <!-- Modal para editar cliente -->
    <div id="edit-client-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Editar Cliente</h3>
                <span class="admin-modal-close" onclick="closeEditClientModal()">&times;</span>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Nombre:</label>
                <input type="text" id="edit-client-full-name" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Tel√©fono:</label>
                <input type="text" id="edit-client-full-phone" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Notas:</label>
                <textarea id="edit-client-notes" class="admin-form-textarea"></textarea>
            </div>
            
            <div class="admin-form-buttons">
                <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeEditClientModal()">Cancelar</button>
                <button class="admin-button" onclick="saveClientChanges()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para nuevo cliente -->
    <div id="new-client-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Nuevo Cliente</h3>
                <span class="admin-modal-close" onclick="closeNewClientModal()">&times;</span>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Nombre:</label>
                <input type="text" id="new-client-full-name" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Tel√©fono:</label>
                <input type="text" id="new-client-full-phone" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Notas:</label>
                <textarea id="new-client-notes" class="admin-form-textarea"></textarea>
            </div>
            
            <div class="admin-form-buttons">
                <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeNewClientModal()">Cancelar</button>
                <button class="admin-button" onclick="createNewClient()">Crear Cliente</button>
            </div>
        </div>
    </div>
    
    <!-- MODALES PARA GESTI√ìN DE SERVICIOS -->
    
    <!-- Modal para editar servicio -->
    <div id="edit-service-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Editar Servicio</h3>
                <span class="admin-modal-close" onclick="closeEditServiceModal()">&times;</span>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Nombre del Servicio:</label>
                <input type="text" id="edit-service-name" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Categor√≠a:</label>
                <select id="edit-service-category" class="admin-form-select">
                    <option value="Pesta√±as">Pesta√±as</option>
                    <option value="Cejas">Cejas</option>
                    <option value="Volumen">Volumen</option>
                    <option value="Paquetes">Paquetes</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Duraci√≥n (minutos):</label>
                <input type="number" id="edit-service-duration" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Precio (S/):</label>
                <input type="number" id="edit-service-price" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Descripci√≥n:</label>
                <textarea id="edit-service-description" class="admin-form-textarea"></textarea>
            </div>
            
            <div class="admin-form-buttons">
                <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeEditServiceModal()">Cancelar</button>
                <button class="admin-button" onclick="saveServiceChanges()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para nuevo servicio -->
    <div id="new-service-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Nuevo Servicio</h3>
                <span class="admin-modal-close" onclick="closeNewServiceModal()">&times;</span>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Nombre del Servicio:</label>
                <input type="text" id="new-service-name" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Categor√≠a:</label>
                <select id="new-service-category" class="admin-form-select">
                    <option value="Pesta√±as">Pesta√±as</option>
                    <option value="Cejas">Cejas</option>
                    <option value="Volumen">Volumen</option>
                    <option value="Paquetes">Paquetes</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Duraci√≥n (minutos):</label>
                <input type="number" id="new-service-duration" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Precio (S/):</label>
                <input type="number" id="new-service-price" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Descripci√≥n:</label>
                <textarea id="new-service-description" class="admin-form-textarea"></textarea>
            </div>
            
            <div class="admin-form-buttons">
                <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeNewServiceModal()">Cancelar</button>
                <button class="admin-button" onclick="createNewService()">Crear Servicio</button>
            </div>
        </div>
    </div>
    
    <!-- MODALES PARA GESTI√ìN DE PROMOCIONES -->
    
    <!-- Modal para editar promoci√≥n -->
    <div id="edit-promotion-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Editar Promoci√≥n</h3>
                <span class="admin-modal-close" onclick="closeEditPromotionModal()">&times;</span>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Nombre de la Promoci√≥n:</label>
                <input type="text" id="edit-promotion-name" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Descripci√≥n:</label>
                <textarea id="edit-promotion-description" class="admin-form-textarea"></textarea>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Descuento (S/ o %):</label>
                <input type="text" id="edit-promotion-discount" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Estado:</label>
                <select id="edit-promotion-status" class="admin-form-select">
                    <option value="active">Activa</option>
                    <option value="inactive">Inactiva</option>
                </select>
            </div>
            
            <div class="admin-form-buttons">
                <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeEditPromotionModal()">Cancelar</button>
                <button class="admin-button" onclick="savePromotionChanges()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para nueva promoci√≥n -->
    <div id="new-promotion-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Nueva Promoci√≥n</h3>
                <span class="admin-modal-close" onclick="closeNewPromotionModal()">&times;</span>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Nombre de la Promoci√≥n:</label>
                <input type="text" id="new-promotion-name" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Descripci√≥n:</label>
                <textarea id="new-promotion-description" class="admin-form-textarea"></textarea>
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Descuento (S/ o %):</label>
                <input type="text" id="new-promotion-discount" class="admin-form-input">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Estado:</label>
                <select id="new-promotion-status" class="admin-form-select">
                    <option value="active">Activa</option>
                    <option value="inactive">Inactiva</option>
                </select>
            </div>
            
            <div class="admin-form-buttons">
                <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeNewPromotionModal()">Cancelar</button>
                <button class="admin-button" onclick="createNewPromotion()">Crear Promoci√≥n</button>
            </div>
        </div>
    </div>
    
    <!-- MODALES PARA GESTI√ìN DE DISPONIBILIDAD -->
    
   <!-- Modal para nuevo horario disponible -->
<div id="new-availability-modal" class="admin-modal">
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3 class="admin-modal-title">Agregar Nuevo Horario</h3>
            <span class="admin-modal-close" onclick="closeNewAvailabilityModal()">&times;</span>
        </div>
        
        <div class="admin-form-group">
            <label class="admin-form-label">Fecha:</label>
            <input type="date" id="new-avail-date" class="admin-form-input">
        </div>
        
        <div class="admin-form-group">
            <label class="admin-form-label">Hora:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="new-avail-hour" class="admin-form-select" style="width: 80px;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
                <span>:</span>
                <select id="new-avail-minute" class="admin-form-select" style="width: 80px;">
                    <option value="00">00</option>
                    <option value="15">15</option>
                    <option value="30">30</option>
                    <option value="45">45</option>
                </select>
                <select id="new-avail-period" class="admin-form-select" style="width: 80px;">
                    <option value="AM">AM</option>
                    <option value="PM">PM</option>
                </select>
            </div>
        </div>
        
        <div class="admin-form-group">
            <label class="admin-form-label">Capacidad:</label>
            <select id="new-avail-capacity" class="admin-form-select">
                <option value="high">Alta disponibilidad</option>
                <option value="medium">Disponibilidad media</option>
                <option value="low">√öltimo espacio</option>
            </select>
        </div>
        
        <div class="admin-form-buttons">
            <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeNewAvailabilityModal()">Cancelar</button>
            <button class="admin-button" onclick="createNewAvailability()">Agregar Horario</button>
        </div>
    </div>
</div>

    <!-- Modal para editar horario disponible -->
<div id="edit-availability-modal" class="admin-modal">
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3 class="admin-modal-title">Editar Horario</h3>
            <span class="admin-modal-close" onclick="closeEditAvailabilityModal()">&times;</span>
        </div>
        
        <div class="admin-form-group">
            <label class="admin-form-label">Fecha:</label>
            <input type="text" id="edit-avail-date" class="admin-form-input" readonly>
        </div>
        
        <div class="admin-form-group">
            <label class="admin-form-label">Hora:</label>
            <input type="text" id="edit-avail-time" class="admin-form-input" readonly>
        </div>
        
        <div class="admin-form-group">
            <label class="admin-form-label">Capacidad:</label>
            <select id="edit-avail-capacity" class="admin-form-select">
                <option value="high">Alta disponibilidad</option>
                <option value="medium">Disponibilidad media</option>
                <option value="low">√öltimo espacio</option>
                <option value="unavailable">No disponible</option>
            </select>
        </div>
        
        <div class="admin-form-buttons">
            <button class="admin-button" style="background-color: #ccc; color: black;" onclick="closeEditAvailabilityModal()">Cancelar</button>
            <button class="admin-button" onclick="saveAvailabilityChanges()">Guardar Cambios</button>
            <button class="admin-button" style="background-color: #e74c3c;" onclick="deleteAvailability()">Eliminar</button>
        </div>
    </div>
</div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
    
    <script>
        // Variables globales
        let currentTab = 'recent';
        let currentFilter = 'all';
        let appointments = [];
        let clients = [];
        let services = [];
        let promotions = [];
        let availableTimes = [];
        
        // Variables para gesti√≥n de m√≥dulos
        let currentClientId = null;
        let currentServiceId = null;
        let currentPromotionId = null;
        let currentAvailabilityId = null;
        let currentAdminMonth = new Date();
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Comprobar si el usuario est√° autenticado
            firebase.auth().onAuthStateChanged(function(user) {
                if (!user) {
                    // Si no hay usuario autenticado, redirigir a login.html
                    window.location.href = 'login.html';
                } else {
                    // Usuario autenticado, mostrar el contenido
                    document.querySelector('.admin-container').style.display = 'block';
                    
                    // Opcional: mostrar informaci√≥n del usuario
                    const adminHeader = document.querySelector('.admin-header');
                    const userInfo = document.createElement('span');
                    userInfo.textContent = user.email;
                    userInfo.style.marginRight = '10px';
                    userInfo.style.fontSize = '14px';
                    
                    const logoutBtn = document.createElement('button');
                    logoutBtn.className = 'view-site';
                    logoutBtn.style.backgroundColor = '#eee';
                    logoutBtn.style.color = '#333';
                    logoutBtn.textContent = 'Cerrar Sesi√≥n';
                    logoutBtn.addEventListener('click', function() {
                        firebase.auth().signOut().then(function() {
                            window.location.href = 'login.html';
                        });
                    });
                    
                    adminHeader.appendChild(userInfo);
                    adminHeader.appendChild(logoutBtn);
                    
                    // Mostrar la fecha actual
                    const today = new Date();
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    document.getElementById('current-date').textContent = 'Hoy: ' + today.toLocaleDateString('es-ES', options);
                    
                    // Cargar datos en tiempo real
                    listenForAdminChanges();
                    
                    // Inicializar funcionamiento de la configuraci√≥n
                    initSettings();
                }
            });
        });
        
        // Escuchar cambios en tiempo real para la administraci√≥n
        function listenForAdminChanges() {
            db.collection('reservas')
                .onSnapshot((snapshot) => {
                    // Actualizar array de citas
                    appointments = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        // Convertir el formato de datos de index.html al formato esperado por admin.html
                        const appointment = {
                            id: doc.id,
                            service: data.servicio,
                            day: data.fecha,
                            time: data.hora,
                            date: data.fechaCreacion,
                            status: data.estado === 'pendiente' ? 'pending' : 
                                   data.estado === 'confirmada' ? 'confirmed' : 'canceled',
                            client: {
                                name: data.nombre,
                                phone: data.telefono,
                                comments: data.comentarios
                            }
                        };
                        
                        appointments.push(appointment);
                    });
                    
                    // Extraer clientes √∫nicos de las reservas
                    clients = extractClients(appointments);
                    
                    // Actualizar UI
                    updateDashboard();
                    loadAppointmentsTable();
                    
                    // Solo actualizar la tabla de clientes si estamos en esa secci√≥n
                    if (document.getElementById('clients').classList.contains('active')) {
                        loadClientsTable();
                    }
                }, (error) => {
                    console.error("Error al escuchar cambios en admin: ", error);
                });
        }
        
        // Extraer clientes √∫nicos de las reservas
        function extractClients(appointments) {
            const clientsMap = new Map();
            
            appointments.forEach(appointment => {
                if (appointment.client && appointment.client.name) {
                    const clientName = appointment.client.name;
                    const clientId = 'client_' + clientName.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    
                    if (!clientsMap.has(clientName)) {
                        clientsMap.set(clientName, {
                            id: clientId,
                            name: clientName,
                            phone: appointment.client.phone || '',
                            appointments: [],
                            lastAppointment: appointment.date || ''
                        });
                    }
                    
                    const client = clientsMap.get(clientName);
                    client.appointments.push(appointment);
                    
                    // Actualizar √∫ltima cita si es m√°s reciente
                    const appointmentDate = new Date(appointment.date || 0);
                    const lastDate = new Date(client.lastAppointment || 0);
                    
                    if (appointmentDate > lastDate) {
                        client.lastAppointment = appointment.date;
                    }
                }
            });
            
            return Array.from(clientsMap.values());
        }
        
        // Actualizar dashboard
        function updateDashboard() {
            // Contar citas de hoy
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayAppointments = appointments.filter(appointment => {
                if (!appointment.day) return false;
                
                const parts = appointment.day.split(' ');
                if (parts.length < 2) return false;
                
                const day = parseInt(parts[1]);
                return day === today.getDate();
            });
            
            // Contar citas pendientes
            const pendingAppointments = appointments.filter(appointment => 
                appointment.status === 'pending'
            );
            
            // Actualizar contadores
            document.getElementById('today-counter').textContent = todayAppointments.length;
            document.getElementById('pending-counter').textContent = pendingAppointments.length;
            document.getElementById('clients-counter').textContent = clients.length;
            
            // Calcular ingresos (simulado)
            document.getElementById('income-counter').textContent = 's/' + calculateIncome();
        }
        
        // Calcular ingresos totales (ejemplo)
        function calculateIncome() {
            let totalIncome = 0;
            
            // Precios de servicios
            const prices = {
                'Lifting de Pesta√±as': 40,
                'Extensiones Cl√°sicas': 50,
                'Efecto R√≠mel': 60,
                'Efecto Mojado': 65,
                'Extensiones H√≠bridas': 70,
                'Volumen Brasile√±o 2D': 80,
                'Volumen Hawaiano 3D': 80,
                'Volumen Griego 4D': 80,
                'Volumen Egipcio 5D': 85,
                'Mega Volumen Egipcio 6D': 110,
                'Visagismo': 10,
                'Depilaci√≥n con cera': 15,
                'Laminado de cejas': 35,
                'Pigmentaci√≥n con henna': 35,
                'Paquete 1: Lifting + Laminado': 60,
                'Paquete 2: Extensiones + Visagismo': 70
            };
            
            // Solo contar citas confirmadas
            const confirmedAppointments = appointments.filter(appointment => 
                appointment.status === 'confirmed'
            );
            
            confirmedAppointments.forEach(appointment => {
                if (appointment.service && prices[appointment.service]) {
                    totalIncome += prices[appointment.service];
                }
            });
            
            return totalIncome;
        }
        
        // Cargar tabla de citas
        function loadAppointmentsTable() {
            const tablesIds = ['appointments-table', 'appointments-data-table'];
            
            tablesIds.forEach(tableId => {
                const tableBody = document.getElementById(tableId);
                if (!tableBody) return;
                
                // Limpiar tabla
                tableBody.innerHTML = '';
                
                // Filtrar seg√∫n la tab actual
                let filteredAppointments = filterAppointmentsByTab(appointments, currentTab);
                
                // Filtrar seg√∫n b√∫squeda adicional
                if (currentFilter !== 'all' && tableId === 'appointments-data-table') {
                    filteredAppointments = filteredAppointments.filter(appointment => 
                        appointment.status === currentFilter
                    );
                }
                
                // Si no hay citas, mostrar mensaje
                if (filteredAppointments.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="admin-empty-state">
                                    <div class="admin-empty-state-icon">üìÖ</div>
                                    <div class="admin-empty-state-text">No hay citas para mostrar</div>
                                    <button class="admin-button" onclick="openNewAppointmentModal()">+ Crear Nueva Cita</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Ordenar citas (m√°s recientes primero)
                filteredAppointments.sort((a, b) => {
                    // Intentar ordenar por fecha
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    
                    return dateB - dateA;
                });
                
                // Cargar citas en la tabla
                filteredAppointments.forEach(appointment => {
                    const row = document.createElement('tr');
                    
                    // Cliente
                    const clientCell = document.createElement('td');
                    clientCell.textContent = appointment.client ? appointment.client.name || 'Sin nombre' : 'Sin nombre';
                    row.appendChild(clientCell);
                    
                    // Servicio
                    const serviceCell = document.createElement('td');
                    serviceCell.textContent = appointment.service || 'No especificado';
                    row.appendChild(serviceCell);
                    
                    // Fecha
                    const dateCell = document.createElement('td');
                    dateCell.textContent = appointment.day || formatDate(appointment.date);
                    row.appendChild(dateCell);
                    
                    // Hora
                    const timeCell = document.createElement('td');
                    timeCell.textContent = appointment.time || 'No especificada';
                    row.appendChild(timeCell);
                    
                    // Estado
                    const statusCell = document.createElement('td');
                    const status = appointment.status || 'pending';
                    let statusBadge = '';
                    
                    if (status === 'pending') {
                        statusBadge = '<span class="admin-badge admin-badge-pending">Pendiente</span>';
                    } else if (status === 'confirmed') {
                        statusBadge = '<span class="admin-badge admin-badge-confirmed">Confirmado</span>';
                    } else if (status === 'canceled') {
                        statusBadge = '<span class="admin-badge admin-badge-canceled">Cancelado</span>';
                    }
                    
                    statusCell.innerHTML = statusBadge;
                    row.appendChild(statusCell);
                    
                    // Acciones
                    const actionsCell = document.createElement('td');
                    let actionButtons = `
                        <button class="admin-action-btn admin-action-edit" onclick="openEditModal('${appointment.id}')">‚úé</button>
                        <button class="admin-action-btn admin-action-whatsapp" onclick="contactClient('${appointment.client ? appointment.client.name || '' : ''}', '${appointment.client ? appointment.client.phone || '' : ''}')">üì±</button>
                    `;
                    
                    if (status === 'pending') {
                        actionButtons += `<button class="admin-action-btn admin-action-confirm" onclick="confirmAppointment('${appointment.id}')">‚úì</button>`;
                    }
                    
                    if (status !== 'canceled') {
                        actionButtons += `<button class="admin-action-btn admin-action-cancel" onclick="cancelAppointment('${appointment.id}')">‚úï</button>`;
                    }
                    
                    actionsCell.innerHTML = actionButtons;
                    row.appendChild(actionsCell);
                    
                    // Agregar fila a la tabla
                    tableBody.appendChild(row);
                });
            });
        }
        
        // Filtrar citas seg√∫n la tab actual
        function filterAppointmentsByTab(appointments, tab) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (tab === 'recent') {
                return appointments; // Todas las citas
            } else if (tab === 'pending') {
                return appointments.filter(appointment => 
                    appointment.status === 'pending'
                );
            } else if (tab === 'today') {
                return appointments.filter(appointment => {
                    if (!appointment.day) return false;
                    
                    const parts = appointment.day.split(' ');
                    if (parts.length < 2) return false;
                    
                    const day = parseInt(parts[1]);
                    return day === today.getDate();
                });
            }
            
            return appointments;
        }
        
        // Cargar tabla de clientes
        function loadClientsTable() {
            const tableBody = document.getElementById('clients-table');
            if (!tableBody) return;
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            // Si no hay clientes, mostrar mensaje
            if (clients.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="admin-empty-state">
                                <div class="admin-empty-state-icon">üë•</div>
                                <div class="admin-empty-state-text">No hay clientes registrados</div>
                                <button class="admin-button" onclick="openNewClientModal()">+ Nuevo Cliente</button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar clientes por nombre
            clients.sort((a, b) => a.name.localeCompare(b.name));
            
            // Cargar clientes en la tabla
            clients.forEach(client => {
                const row = document.createElement('tr');
                
                // Nombre
                const nameCell = document.createElement('td');
                nameCell.textContent = client.name;
                row.appendChild(nameCell);
                
                // Tel√©fono
                const phoneCell = document.createElement('td');
                phoneCell.textContent = client.phone || 'No especificado';
                row.appendChild(phoneCell);
                
                // √öltima visita
                const lastVisitCell = document.createElement('td');
                lastVisitCell.textContent = formatDate(client.lastAppointment);
                row.appendChild(lastVisitCell);
                
                // Total citas
                const totalAppointmentsCell = document.createElement('td');
                totalAppointmentsCell.textContent = client.appointments.length;
                row.appendChild(totalAppointmentsCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="admin-action-btn admin-action-edit" onclick="openEditClientModal('${client.id}')">‚úé</button>
                    <button class="admin-action-btn admin-action-whatsapp" onclick="contactClient('${client.name}', '${client.phone}')">üì±</button>
                    <button class="admin-action-btn admin-action-cancel" onclick="deleteClient('${client.id}')">‚úï</button>
                `;
                row.appendChild(actionsCell);
                
                // Agregar fila a la tabla
                tableBody.appendChild(row);
            });
        }
        
        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'No registrada';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES');
            } catch (e) {
                return 'Fecha inv√°lida';
            }
        }
        
        // Mostrar secci√≥n
        function showSection(sectionId) {
            // Ocultar todas las secciones
            const sections = document.querySelectorAll('.admin-content');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionId).classList.add('active');
            
            // Actualizar men√∫
            const menuLinks = document.querySelectorAll('.admin-menu-link');
            menuLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            // Activar el enlace actual
            event.currentTarget.classList.add('active');
            
            // Cargar datos espec√≠ficos de la secci√≥n
            if (sectionId === 'dashboard') {
                loadAppointmentsTable();
            } else if (sectionId === 'appointments') {
                loadAppointmentsTable();
                // Restablecer la vista de citas (ocultar secci√≥n de disponibilidad)
                hideAvailabilitySection();
                // Establecer la primera tab como activa
                const tabs = document.querySelectorAll('#appointments .admin-tab');
                tabs.forEach((tab, index) => {
                    tab.classList.toggle('active', index === 0);
                });
                currentFilter = 'all';
            } else if (sectionId === 'clients') {
                loadClientsTable();
            } else if (sectionId === 'services') {
                loadServices();
            } else if (sectionId === 'promotions') {
                loadPromotions();
            } else if (sectionId === 'settings') {
                loadSettings();
            }
        }
        
        // Mostrar tab
        function showTab(tabId) {
            // Actualizar tabs
            const tabs = document.querySelectorAll('.admin-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activar la tab seleccionada
            event.currentTarget.classList.add('active');
            
            // Actualizar tab actual
            currentTab = tabId;
            
            // Recargar tabla de citas
            loadAppointmentsTable();
        }
        
        // Filtrar citas en la secci√≥n de citas
        function filterAppointments(filter) {
            // Si se muestra la secci√≥n de disponibilidad, ocultarla
            hideAvailabilitySection();
            
            // Actualizar filtro actual
            currentFilter = filter;
            
            // Actualizar tabs
            const tabs = document.querySelectorAll('#appointments .admin-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activar la tab seleccionada (excepto la √∫ltima que es Disponibilidad)
            if (filter === 'all') tabs[0].classList.add('active');
            else if (filter === 'pending') tabs[1].classList.add('active');
            else if (filter === 'confirmed') tabs[2].classList.add('active');
            else if (filter === 'canceled') tabs[3].classList.add('active');
            
            // Recargar tabla de citas
            loadAppointmentsTable();
        }
        
        // Buscar citas
        function searchAppointments() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchText.trim()) {
                // Si no hay texto, mostrar todas las citas
                loadAppointmentsTable();
                return;
            }
            
            // Filtrar citas seg√∫n el texto de b√∫squeda
            const filteredAppointments = appointments.filter(appointment => {
                const clientName = appointment.client ? appointment.client.name || '' : '';
                const service = appointment.service || '';
                const day = appointment.day || '';
                
                return (
                    clientName.toLowerCase().includes(searchText) ||
                    service.toLowerCase().includes(searchText) ||
                    day.toLowerCase().includes(searchText)
                );
            });
            
            // Actualizar tabla con las citas filtradas
            const tableBody = document.getElementById('appointments-table');
            if (!tableBody) return;
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            // Si no hay resultados, mostrar mensaje
            if (filteredAppointments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="admin-empty-state">
                                <div class="admin-empty-state-text">No se encontraron resultados para "${searchText}"</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Cargar citas filtradas
            filteredAppointments.forEach(appointment => {
                const row = document.createElement('tr');
                
                // Cliente
                const clientCell = document.createElement('td');
                clientCell.textContent = appointment.client ? appointment.client.name || 'Sin nombre' : 'Sin nombre';
                row.appendChild(clientCell);
                
                // Servicio
                const serviceCell = document.createElement('td');
                serviceCell.textContent = appointment.service || 'No especificado';
                row.appendChild(serviceCell);
                
                // Fecha
                const dateCell = document.createElement('td');
                dateCell.textContent = appointment.day || formatDate(appointment.date);
                row.appendChild(dateCell);
                
                // Hora
                const timeCell = document.createElement('td');
                timeCell.textContent = appointment.time || 'No especificada';
                row.appendChild(timeCell);
                
                // Estado
                const statusCell = document.createElement('td');
                const status = appointment.status || 'pending';
                let statusBadge = '';
                
                if (status === 'pending') {
                    statusBadge = '<span class="admin-badge admin-badge-pending">Pendiente</span>';
                } else if (status === 'confirmed') {
                    statusBadge = '<span class="admin-badge admin-badge-confirmed">Confirmado</span>';
                } else if (status === 'canceled') {
                    statusBadge = '<span class="admin-badge admin-badge-canceled">Cancelado</span>';
                }
                
                statusCell.innerHTML = statusBadge;
                row.appendChild(statusCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                let actionButtons = `
                    <button class="admin-action-btn admin-action-edit" onclick="openEditModal('${appointment.id}')">‚úé</button>
                    <button class="admin-action-btn admin-action-whatsapp" onclick="contactClient('${appointment.client ? appointment.client.name || '' : ''}', '${appointment.client ? appointment.client.phone || '' : ''}')">üì±</button>
                `;
                
                if (status === 'pending') {
                    actionButtons += `<button class="admin-action-btn admin-action-confirm" onclick="confirmAppointment('${appointment.id}')">‚úì</button>`;
                }
                
                if (status !== 'canceled') {
                    actionButtons += `<button class="admin-action-btn admin-action-cancel" onclick="cancelAppointment('${appointment.id}')">‚úï</button>`;
                }
                
                actionsCell.innerHTML = actionButtons;
                row.appendChild(actionsCell);
                
                // Agregar fila a la tabla
                tableBody.appendChild(row);
            });
        }
        
        // B√∫squeda espec√≠fica para secci√≥n de citas
        function searchAppointmentsData() {
            const searchText = document.getElementById('appointments-search').value.toLowerCase();
            
            if (!searchText.trim()) {
                // Si no hay texto, mostrar todas las citas
                loadAppointmentsTable();
                return;
            }
            
            // Aplicar el mismo filtro que searchAppointments pero para la otra tabla
            const filteredAppointments = appointments.filter(appointment => {
                const clientName = appointment.client ? appointment.client.name || '' : '';
                const service = appointment.service || '';
                const day = appointment.day || '';
                
                return (
                    clientName.toLowerCase().includes(searchText) ||
                    service.toLowerCase().includes(searchText) ||
                    day.toLowerCase().includes(searchText)
                );
            });
            
            // Actualizar tabla de citas
            const tableBody = document.getElementById('appointments-data-table');
            if (!tableBody) return;
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            // Si no hay resultados, mostrar mensaje
            if (filteredAppointments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="admin-empty-state">
                                <div class="admin-empty-state-text">No se encontraron resultados para "${searchText}"</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Cargar citas filtradas igual que en searchAppointments
            filteredAppointments.forEach(appointment => {
                const row = document.createElement('tr');
                
                // Cliente
                const clientCell = document.createElement('td');
                clientCell.textContent = appointment.client ? appointment.client.name || 'Sin nombre' : 'Sin nombre';
                row.appendChild(clientCell);
                
                // Servicio
                const serviceCell = document.createElement('td');
                serviceCell.textContent = appointment.service || 'No especificado';
                row.appendChild(serviceCell);
                
                // Fecha
                const dateCell = document.createElement('td');
                dateCell.textContent = appointment.day || formatDate(appointment.date);
                row.appendChild(dateCell);
                
                // Hora
                const timeCell = document.createElement('td');
                timeCell.textContent = appointment.time || 'No especificada';
                row.appendChild(timeCell);
                
                // Estado
                const statusCell = document.createElement('td');
                const status = appointment.status || 'pending';
                let statusBadge = '';
                
                if (status === 'pending') {
                    statusBadge = '<span class="admin-badge admin-badge-pending">Pendiente</span>';
                } else if (status === 'confirmed') {
                    statusBadge = '<span class="admin-badge admin-badge-confirmed">Confirmado</span>';
                } else if (status === 'canceled') {
                    statusBadge = '<span class="admin-badge admin-badge-canceled">Cancelado</span>';
                }
                
                statusCell.innerHTML = statusBadge;
                row.appendChild(statusCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                let actionButtons = `
                    <button class="admin-action-btn admin-action-edit" onclick="openEditModal('${appointment.id}')">‚úé</button>
                    <button class="admin-action-btn admin-action-whatsapp" onclick="contactClient('${appointment.client ? appointment.client.name || '' : ''}', '${appointment.client ? appointment.client.phone || '' : ''}')">üì±</button>
                `;
                
                if (status === 'pending') {
                    actionButtons += `<button class="admin-action-btn admin-action-confirm" onclick="confirmAppointment('${appointment.id}')">‚úì</button>`;
                }
                
                if (status !== 'canceled') {
                    actionButtons += `<button class="admin-action-btn admin-action-cancel" onclick="cancelAppointment('${appointment.id}')">‚úï</button>`;
                }
                
                actionsCell.innerHTML = actionButtons;
                row.appendChild(actionsCell);
                
                // Agregar fila a la tabla
                tableBody.appendChild(row);
            });
        }
        
        // Abrir modal de edici√≥n
        function openEditModal(appointmentId) {
            // Buscar cita por ID
            const appointment = appointments.find(a => a.id === appointmentId);
            
            if (!appointment) {
                alert('No se encontr√≥ la cita');
                return;
            }
            
            // Llenar formulario
            document.getElementById('edit-client-name').value = appointment.client ? appointment.client.name || '' : '';
            document.getElementById('edit-client-phone').value = appointment.client ? appointment.client.phone || '' : '';
            
            // Seleccionar servicio
            const serviceSelect = document.getElementById('edit-service');
            for (let i = 0; i < serviceSelect.options.length; i++) {
                if (serviceSelect.options[i].text === appointment.service) {
                    serviceSelect.selectedIndex = i;
                    break;
                }
            }
            
            // Establecer fecha
            // Para simplificar, usamos la fecha actual
            const today = new Date();
            document.getElementById('edit-date').value = today.toISOString().split('T')[0];
            
            // Seleccionar hora
            const timeSelect = document.getElementById('edit-time');
            for (let i = 0; i < timeSelect.options.length; i++) {
                if (timeSelect.options[i].text === appointment.time) {
                    timeSelect.selectedIndex = i;
                    break;
                }
            }
            
            // Seleccionar estado
            document.getElementById('edit-status').value = appointment.status || 'pending';
            
            // Establecer observaciones
            document.getElementById('edit-notes').value = appointment.client && appointment.client.comments ? appointment.client.comments : '';
            
            // Guardar ID de la cita
            document.getElementById('edit-appointment-modal').setAttribute('data-appointment-id', appointmentId);
            
            // Mostrar modal
            document.getElementById('edit-appointment-modal').style.display = 'block';
        }
        
        // Cerrar modal de edici√≥n
        function closeEditModal() {
            document.getElementById('edit-appointment-modal').style.display = 'none';
        }
        
        // Editar cita
        function saveAppointment() {
            // Obtener ID de la cita
            const appointmentId = document.getElementById('edit-appointment-modal').getAttribute('data-appointment-id');
            
            // Validar ID
            if (!appointmentId) {
                alert('No se encontr√≥ el ID de la cita');
                return;
            }
            
            // Obtener datos del formulario
            const clientName = document.getElementById('edit-client-name').value;
            const clientPhone = document.getElementById('edit-client-phone').value;
            const service = document.getElementById('edit-service').value;
            const date = document.getElementById('edit-date').value;
            const time = document.getElementById('edit-time').value;
            const status = document.getElementById('edit-status').value;
            const notes = document.getElementById('edit-notes').value;
            
            // Validar datos
            if (!clientName) {
                alert('El nombre del cliente es obligatorio');
                return;
            }
            
            // Calcular d√≠a formateado (ej. "Lunes 1 Mayo")
            const day = getDayFromDate(date);
            
            // Preparar datos para actualizar en el formato de index.html
            const updatedData = {
                servicio: service,
                fecha: day,
                hora: time,
                estado: status === 'pending' ? 'pendiente' : 
                        status === 'confirmed' ? 'confirmada' : 'cancelada',
                nombre: clientName,
                telefono: clientPhone,
                comentarios: notes,
                fechaActualizacion: new Date().toISOString()
            };
            
            // Actualizar en Firestore
            db.collection('reservas').doc(appointmentId)
                .update(updatedData)
                .then(() => {
                    console.log("Cita actualizada con √©xito");
                    // Cerrar modal
                    closeEditModal();
                    // Recargar datos
                    loadAppointmentsTable();
                    // Mostrar mensaje
                    alert('Cita actualizada correctamente');
                })
                .catch((error) => {
                    console.error("Error al actualizar la cita: ", error);
                    alert('Error al actualizar la cita. Int√©ntalo de nuevo.');
                });
        }
        
        // Abrir modal de nueva cita
        function openNewAppointmentModal() {
            // Limpiar formulario
            document.getElementById('new-client-name').value = '';
            document.getElementById('new-client-phone').value = '';
            document.getElementById('new-notes').value = '';
            
            // Establecer fecha actual
            const today = new Date();
            document.getElementById('new-date').value = today.toISOString().split('T')[0];
            
            // Actualizar select de servicios con los servicios disponibles
            updateServiceSelects();
            
            // Mostrar modal
            document.getElementById('new-appointment-modal').style.display = 'block';
        }
        
        // Cerrar modal de nueva cita
        function closeNewAppointmentModal() {
            document.getElementById('new-appointment-modal').style.display = 'none';
        }
        
        // Crear nueva cita
        function createAppointment() {
            // Obtener datos del formulario
            const clientName = document.getElementById('new-client-name').value;
            const clientPhone = document.getElementById('new-client-phone').value;
            const service = document.getElementById('new-service').value;
            const date = document.getElementById('new-date').value;
            const time = document.getElementById('new-time').value;
            const status = document.getElementById('new-status').value;
            const notes = document.getElementById('new-notes').value;
            
            // Validar datos
            if (!clientName) {
                alert('El nombre del cliente es obligatorio');
                return;
            }
            
            // Calcular d√≠a formateado
            const day = getDayFromDate(date);
            
            // ID √∫nico basado en timestamp
            const appointmentId = Date.now().toString();
            
            // Crear nueva cita en el formato de index.html
            const newAppointment = {
                nombre: clientName,
                telefono: clientPhone,
                servicio: service,
                fecha: day,
                hora: time,
                estado: status === 'pending' ? 'pendiente' : 'confirmada',
                comentarios: notes,
                fechaCreacion: new Date().toISOString(),
                metodoPago: 'Pendiente'
            };
            
            // Guardar en Firestore
            db.collection('reservas').doc(appointmentId)
                .set(newAppointment)
                .then(() => {
                    console.log("Cita creada con √©xito");
                    // Cerrar modal
                    closeNewAppointmentModal();
                    // Recargar datos
                    loadAppointmentsTable();
                    // Mostrar mensaje
                    alert('Cita creada correctamente');
                })
                .catch((error) => {
                    console.error("Error al crear la cita: ", error);
                    alert('Error al crear la cita. Int√©ntalo de nuevo.');
                });
        }
        
        // Actualizar selects de servicios
        function updateServiceSelects() {
            // Obtener los selects
            const newServiceSelect = document.getElementById('new-service');
            const editServiceSelect = document.getElementById('edit-service');
            
            // Si no hay servicios cargados, cargarlos primero
            if (services.length === 0) {
                db.collection('servicios')
                    .get()
                    .then((snapshot) => {
                        // Limpiar selects
                        newServiceSelect.innerHTML = '';
                        editServiceSelect.innerHTML = '';
                        
                        // Si no hay servicios, usar los predeterminados
                        if (snapshot.empty) {
                            return;
                        }
                        
                        // Procesar servicios
                        const servicesByCategory = {};
                        
                        snapshot.forEach((doc) => {
                            const service = doc.data();
                            
                            if (!servicesByCategory[service.categoria]) {
                                servicesByCategory[service.categoria] = [];
                            }
                            
                            servicesByCategory[service.categoria].push(service);
                        });
                        
                        // Agregar opciones agrupadas por categor√≠a
                        Object.keys(servicesByCategory).forEach(category => {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = category;
                            
                            servicesByCategory[category].forEach(service => {
                                const option = document.createElement('option');
                                option.value = service.nombre;
                                option.textContent = `${service.nombre} - s/${service.precio}`;
                                optgroup.appendChild(option);
                                
                                // Clonar para el otro select
                                const optionClone = option.cloneNode(true);
                                optgroup.appendChild(optionClone);
                            });
                            
                            newServiceSelect.appendChild(optgroup);
                            // Clonar para el otro select
                            const optgroupClone = optgroup.cloneNode(true);
                            editServiceSelect.appendChild(optgroupClone);
                        });
                    })
                    .catch((error) => {
                        console.error("Error al cargar servicios: ", error);
                    });
            }
        }
        
        // Convertir fecha a formato "Lunes 1 Mayo"
        function getDayFromDate(dateString) {
            const date = new Date(dateString);
            
            const weekdays = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const weekday = weekdays[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            
            return `${weekday} ${day} ${month}`;
        }
        
        // Confirmar cita
        function confirmAppointment(appointmentId) {
            return db.collection('reservas').doc(appointmentId)
                .update({
                    estado: 'confirmada',
                    fechaActualizacion: new Date().toISOString()
                })
                .then(() => {
                    console.log("Cita confirmada con √©xito");
                    // Opcional: Mostrar un mensaje de √©xito
                    alert('Cita confirmada correctamente');
                    // Recargar datos o actualizar UI
                    loadAppointmentsTable();
                })
                .catch((error) => {
                    console.error("Error al confirmar la cita: ", error);
                    alert('Error al confirmar la cita. Int√©ntalo de nuevo.');
                });
        }
        
        // Cancelar cita
        function cancelAppointment(appointmentId) {
            // Confirmar cancelaci√≥n
            if (!confirm('¬øEst√°s seguro de que deseas cancelar esta cita?')) {
                return Promise.resolve(false);
            }
            
            return db.collection('reservas').doc(appointmentId)
                .update({
                    estado: 'cancelada',
                    fechaActualizacion: new Date().toISOString()
                })
                .then(() => {
                    console.log("Cita cancelada con √©xito");
                    // Opcional: Mostrar un mensaje de √©xito
                    alert('Cita cancelada correctamente');
                    // Recargar datos o actualizar UI
                    loadAppointmentsTable();
                    return true;
                })
                .catch((error) => {
                    console.error("Error al cancelar la cita: ", error);
                    alert('Error al cancelar la cita. Int√©ntalo de nuevo.');
                    return false;
                });
        }
        
        // Contactar cliente por WhatsApp
        function contactClient(name, phone) {
            if (!phone) {
                alert('El cliente no tiene n√∫mero de tel√©fono registrado');
                return;
            }
            
            // Crear mensaje
            const message = `Hola ${name}, te contactamos desde MG STUDIO para confirmar tu cita.`;
            
            // Abrir WhatsApp
            window.open(`https://wa.me/51${phone}?text=${encodeURIComponent(message)}`, '_blank');
        }
        
        // Buscar clientes
        function searchClients() {
            const searchText = document.getElementById('clients-search').value.toLowerCase();
            
            if (!searchText.trim()) {
                // Si no hay texto, mostrar todos los clientes
                loadClientsTable();
                return;
            }
            
            // Filtrar clientes seg√∫n el texto de b√∫squeda
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchText) ||
                (client.phone && client.phone.includes(searchText))
            );
            
            // Actualizar tabla con los clientes filtrados
            const tableBody = document.getElementById('clients-table');
            if (!tableBody) return;
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            // Si no hay resultados, mostrar mensaje
            if (filteredClients.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="admin-empty-state">
                                <div class="admin-empty-state-text">No se encontraron resultados para "${searchText}"</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Cargar clientes filtrados
            filteredClients.forEach(client => {
                const row = document.createElement('tr');
                
                // Nombre
                const nameCell = document.createElement('td');
                nameCell.textContent = client.name;
                row.appendChild(nameCell);
                
                // Tel√©fono
                const phoneCell = document.createElement('td');
                phoneCell.textContent = client.phone || 'No especificado';
                row.appendChild(phoneCell);
                
                // √öltima visita
                const lastVisitCell = document.createElement('td');
                lastVisitCell.textContent = formatDate(client.lastAppointment);
                row.appendChild(lastVisitCell);
                
                // Total citas
                const totalAppointmentsCell = document.createElement('td');
                totalAppointmentsCell.textContent = client.appointments.length;
                row.appendChild(totalAppointmentsCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="admin-action-btn admin-action-edit" onclick="openEditClientModal('${client.id}')">‚úé</button>
                    <button class="admin-action-btn admin-action-whatsapp" onclick="contactClient('${client.name}', '${client.phone}')">üì±</button>
                    <button class="admin-action-btn admin-action-cancel" onclick="deleteClient('${client.id}')">‚úï</button>
                `;
                row.appendChild(actionsCell);
                
                // Agregar fila a la tabla
                tableBody.appendChild(row);
            });
        }
        
        // ===== FUNCIONES PARA GESTI√ìN DE CLIENTES =====
        
        // Abrir modal de edici√≥n de cliente
        function openEditClientModal(clientId) {
            // Buscar cliente
            const client = clients.find(c => c.id === clientId);
            
            if (!client) {
                alert('Cliente no encontrado');
                return;
            }
            
            // Llenar formulario con datos del cliente
            document.getElementById('edit-client-full-name').value = client.name || '';
            document.getElementById('edit-client-full-phone').value = client.phone || '';
            document.getElementById('edit-client-notes').value = client.notes || '';
            
            // Guardar ID del cliente actual
            currentClientId = clientId;
            
            // Mostrar modal
            document.getElementById('edit-client-modal').style.display = 'block';
        }
        
        // Cerrar modal de edici√≥n de cliente
        function closeEditClientModal() {
            document.getElementById('edit-client-modal').style.display = 'none';
            currentClientId = null;
        }
        
        // Guardar cambios de cliente
        function saveClientChanges() {
            // Verificar que hay un cliente seleccionado
            if (!currentClientId) {
                alert('No hay cliente seleccionado');
                return;
            }
            
            // Obtener datos del formulario
            const name = document.getElementById('edit-client-full-name').value;
            const phone = document.getElementById('edit-client-full-phone').value;
            const notes = document.getElementById('edit-client-notes').value;
            
            // Validar datos
            if (!name) {
                alert('El nombre del cliente es obligatorio');
                return;
            }
            
            // Preparar datos actualizados
            const updatedData = {
                nombre: name,
                telefono: phone,
                notas: notes,
                fechaActualizacion: new Date().toISOString()
            };
            
            // Actualizar en Firestore
            db.collection('clientes').doc(currentClientId)
                .update(updatedData)
                .then(() => {
                    console.log("Cliente actualizado con √©xito");
                    // Cerrar modal
                    closeEditClientModal();
                    // Recargar lista de clientes
                    loadClientsTable();
                    // Mostrar mensaje
                    alert('Cliente actualizado correctamente');
                })
                .catch((error) => {
                    console.error("Error al actualizar el cliente: ", error);
                    alert('Error al actualizar el cliente. Int√©ntalo de nuevo.');
                });
        }
        
        // Abrir modal para nuevo cliente
        function openNewClientModal() {
            // Limpiar formulario
            document.getElementById('new-client-full-name').value = '';
            document.getElementById('new-client-full-phone').value = '';
            document.getElementById('new-client-notes').value = '';
            
            // Mostrar modal
            document.getElementById('new-client-modal').style.display = 'block';
        }
        
        // Cerrar modal de nuevo cliente
        function closeNewClientModal() {
            document.getElementById('new-client-modal').style.display = 'none';
        }
        
        // Crear nuevo cliente
        function createNewClient() {
            // Obtener datos del formulario
            const name = document.getElementById('new-client-full-name').value;
            const phone = document.getElementById('new-client-full-phone').value;
            const notes = document.getElementById('new-client-notes').value;
            
            // Validar datos
            if (!name) {
                alert('El nombre del cliente es obligatorio');
                return;
            }
            
            // ID √∫nico basado en timestamp
            const clientId = 'client_' + Date.now().toString();
            
            // Crear nuevo cliente
            const newClient = {
                id: clientId,
                nombre: name,
                telefono: phone,
                notas: notes,
                fechaCreacion: new Date().toISOString(),
                citas: []
            };
            
            // Guardar en Firestore
            db.collection('clientes').doc(clientId)
                .set(newClient)
                .then(() => {
                    console.log("Cliente creado con √©xito");
                    // Cerrar modal
                    closeNewClientModal();
                    // Actualizar lista de clientes
                    loadClientsTable();
                    // Mostrar mensaje
                    alert('Cliente creado correctamente');
                })
                .catch((error) => {
                    console.error("Error al crear el cliente: ", error);
                    alert('Error al crear el cliente. Int√©ntalo de nuevo.');
                });
        }
        
        // Eliminar cliente
        function deleteClient(clientId) {
            // Confirmar eliminaci√≥n
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este cliente? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            // Eliminar de Firestore
            db.collection('clientes').doc(clientId)
                .delete()
                .then(() => {
                    console.log("Cliente eliminado con √©xito");
                    // Recargar lista de clientes
                    loadClientsTable();
                    // Mostrar mensaje
                    alert('Cliente eliminado correctamente');
                })
                .catch((error) => {
                    console.error("Error al eliminar el cliente: ", error);
                    alert('Error al eliminar el cliente. Int√©ntalo de nuevo.');
                });
        }
        
        // ===== FUNCIONES PARA GESTI√ìN DE SERVICIOS =====
        
        // Cargar servicios desde Firestore
        function loadServices() {
            db.collection('servicios')
                .get()
                .then((snapshot) => {
                    services = [];
                    snapshot.forEach((doc) => {
                        services.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderServicesTable();
                })
                .catch((error) => {
                    console.error("Error al cargar servicios:", error);
                });
        }
        
        // Renderizar tabla de servicios
        function renderServicesTable() {
            const tableBody = document.getElementById('services-table');
            if (!tableBody) return;
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            if (services.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="admin-empty-state">
                                <div class="admin-empty-state-icon">üíÑ</div>
                                <div class="admin-empty-state-text">No hay servicios registrados</div>
                                <button class="admin-button" onclick="openNewServiceModal()">+ Agregar Servicio</button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar servicios por categor√≠a y nombre
            services.sort((a, b) => {
                if (a.categoria !== b.categoria) {
                    return a.categoria.localeCompare(b.categoria);
                }
                return a.nombre.localeCompare(b.nombre);
            });
            
            // Renderizar cada servicio
            services.forEach(service => {
                const row = document.createElement('tr');
                
                // Nombre
                const nameCell = document.createElement('td');
                nameCell.textContent = service.nombre;
                row.appendChild(nameCell);
                
                // Categor√≠a
                const categoryCell = document.createElement('td');
                categoryCell.textContent = service.categoria;
                row.appendChild(categoryCell);
                
                // Duraci√≥n
                const durationCell = document.createElement('td');
                durationCell.textContent = service.duracion + ' min';
                row.appendChild(durationCell);
                
                // Precio
                const priceCell = document.createElement('td');
                priceCell.textContent = 's/' + service.precio;
                row.appendChild(priceCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="admin-action-btn admin-action-edit" onclick="openEditServiceModal('${service.id}')">‚úé</button>
                    <button class="admin-action-btn admin-action-cancel" onclick="deleteService('${service.id}')">‚úï</button>
                `;
                row.appendChild(actionsCell);
                
                // Agregar fila a la tabla
                tableBody.appendChild(row);
            });
        }
        
        // Abrir modal para nuevo servicio
        function openNewServiceModal() {
            // Limpiar formulario
            document.getElementById('new-service-name').value = '';
            document.getElementById('new-service-category').value = 'Pesta√±as';
            document.getElementById('new-service-duration').value = '60';
            document.getElementById('new-service-price').value = '';
            document.getElementById('new-service-description').value = '';
            
            // Mostrar modal
            document.getElementById('new-service-modal').style.display = 'block';
        }
        
        // Cerrar modal de nuevo servicio
        function closeNewServiceModal() {
            document.getElementById('new-service-modal').style.display = 'none';
        }
        
        // Crear nuevo servicio
        function createNewService() {
            // Obtener datos del formulario
            const name = document.getElementById('new-service-name').value;
            const category = document.getElementById('new-service-category').value;
            const duration = document.getElementById('new-service-duration').value;
            const price = document.getElementById('new-service-price').value;
            const description = document.getElementById('new-service-description').value;
            
            // Validar datos
            if (!name) {
                alert('El nombre del servicio es obligatorio');
                return;
            }
            
            if (!duration || isNaN(duration) || parseInt(duration) <= 0) {
                alert('La duraci√≥n debe ser un n√∫mero positivo');
                return;
            }
            
            if (!price || isNaN(price) || parseFloat(price) <= 0) {
                alert('El precio debe ser un n√∫mero positivo');
                return;
            }
            
            // ID √∫nico
            const serviceId = 'service_' + Date.now().toString();
            
            // Crear servicio
            const newService = {
                id: serviceId,
                nombre: name,
                categoria: category,
                duracion: parseInt(duration),
                precio: parseFloat(price),
                descripcion: description,
                fechaCreacion: new Date().toISOString()
            };
            
            // Guardar en Firestore
            db.collection('servicios').doc(serviceId)
                .set(newService)
                .then(() => {
                    console.log("Servicio creado con √©xito");
                    // Cerrar modal
                    closeNewServiceModal();
                    // Recargar servicios
                    loadServices();
                    // Mostrar mensaje
                    alert('Servicio creado correctamente');
                })
                .catch((error) => {
                    console.error("Error al crear el servicio: ", error);
                    alert('Error al crear el servicio. Int√©ntalo de nuevo.');
                });
        }
        
        // Abrir modal de edici√≥n de servicio
        function openEditServiceModal(serviceId) {
            // Buscar servicio
            const service = services.find(s => s.id === serviceId);
            
            if (!service) {
                alert('Servicio no encontrado');
                return;
            }
            
            // Llenar formulario
            document.getElementById('edit-service-name').value = service.nombre;
            document.getElementById('edit-service-category').value = service.categoria;
            document.getElementById('edit-service-duration').value = service.duracion;
            document.getElementById('edit-service-price').value = service.precio;
            document.getElementById('edit-service-description').value = service.descripcion || '';
            
            // Guardar ID del servicio actual
            currentServiceId = serviceId;
            
            // Mostrar modal
            document.getElementById('edit-service-modal').style.display = 'block';
        }
        
        // Cerrar modal de edici√≥n de servicio
        function closeEditServiceModal() {
            document.getElementById('edit-service-modal').style.display = 'none';
            currentServiceId = null;
        }
        
        // Guardar cambios de servicio
        function saveServiceChanges() {
            // Verificar que hay un servicio seleccionado
            if (!currentServiceId) {
                alert('No hay servicio seleccionado');
                return;
            }
            
            // Obtener datos del formulario
            const name = document.getElementById('edit-service-name').value;
            const category = document.getElementById('edit-service-category').value;
            const duration = document.getElementById('edit-service-duration').value;
            const price = document.getElementById('edit-service-price').value;
            const description = document.getElementById('edit-service-description').value;
            
            // Validar datos (igual que en createNewService)
            if (!name) {
                alert('El nombre del servicio es obligatorio');
                return;
            }
            
            if (!duration || isNaN(duration) || parseInt(duration) <= 0) {
                alert('La duraci√≥n debe ser un n√∫mero positivo');
                return;
            }
            
            if (!price || isNaN(price) || parseFloat(price) <= 0) {
                alert('El precio debe ser un n√∫mero positivo');
                return;
            }
            
            // Preparar datos actualizados
            const updatedData = {
                nombre: name,
                categoria: category,
                duracion: parseInt(duration),
                precio: parseFloat(price),
                descripcion: description,
                fechaActualizacion: new Date().toISOString()
            };
            
            // Actualizar en Firestore
            db.collection('servicios').doc(currentServiceId)
                .update(updatedData)
                .then(() => {
                    console.log("Servicio actualizado con √©xito");
                    // Cerrar modal
                    closeEditServiceModal();
                    // Recargar servicios
                    loadServices();
                    // Mostrar mensaje
                    alert('Servicio actualizado correctamente');
                })
                .catch((error) => {
                    console.error("Error al actualizar el servicio: ", error);
                    alert('Error al actualizar el servicio. Int√©ntalo de nuevo.');
                });
        }
        
        // Eliminar servicio
        function deleteService(serviceId) {
            // Confirmar eliminaci√≥n
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este servicio? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            // Eliminar de Firestore
            db.collection('servicios').doc(serviceId)
                .delete()
                .then(() => {
                    console.log("Servicio eliminado con √©xito");
                    // Recargar servicios
                    loadServices();
                    // Mostrar mensaje
                    alert('Servicio eliminado correctamente');
                })
                .catch((error) => {
                    console.error("Error al eliminar el servicio: ", error);
                    alert('Error al eliminar el servicio. Int√©ntalo de nuevo.');
                });
        }
        
        // Buscar servicios
        function searchServices() {
            const searchText = document.getElementById('services-search').value.toLowerCase();
            
            if (!searchText.trim()) {
                // Si no hay texto, mostrar todos los servicios
                renderServicesTable();
                return;
            }
            
            // Filtrar servicios seg√∫n el texto de b√∫squeda
            const filteredServices = services.filter(service => 
                service.nombre.toLowerCase().includes(searchText) ||
                service.categoria.toLowerCase().includes(searchText) ||
                (service.descripcion && service.descripcion.toLowerCase().includes(searchText))
            );
            
            // Actualizar tabla con los servicios filtrados
            const tableBody = document.getElementById('services-table');
            if (!tableBody) return;
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            // Si no hay resultados, mostrar mensaje
            if (filteredServices.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="admin-empty-state">
                                <div class="admin-empty-state-text">No se encontraron resultados para "${searchText}"</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Cargar servicios filtrados
            filteredServices.forEach(service => {
                const row = document.createElement('tr');
                
                // Nombre
                const nameCell = document.createElement('td');
                nameCell.textContent = service.nombre;
                row.appendChild(nameCell);
                
                // Categor√≠a
                const categoryCell = document.createElement('td');
                categoryCell.textContent = service.categoria;
                row.appendChild(categoryCell);
                
                // Duraci√≥n
                const durationCell = document.createElement('td');
                durationCell.textContent = service.duracion + ' min';
                row.appendChild(durationCell);
                
                // Precio
                const priceCell = document.createElement('td');
                priceCell.textContent = 's/' + service.precio;
                row.appendChild(priceCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="admin-action-btn admin-action-edit" onclick="openEditServiceModal('${service.id}')">‚úé</button>
                    <button class="admin-action-btn admin-action-cancel" onclick="deleteService('${service.id}')">‚úï</button>
                `;
                row.appendChild(actionsCell);
                
                // Agregar fila a la tabla
                tableBody.appendChild(row);
            });
        }
        
        // ===== FUNCIONES PARA GESTI√ìN DE PROMOCIONES =====
        
        // Cargar promociones desde Firestore
        function loadPromotions() {
            db.collection('promociones')
                .get()
                .then((snapshot) => {
                    promotions = [];
                    snapshot.forEach((doc) => {
                        promotions.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderPromotions();
                })
                .catch((error) => {
                    console.error("Error al cargar promociones:", error);
                });
        }
        
        // Renderizar promociones
        function renderPromotions() {
            const container = document.getElementById('promotions-container');
            if (!container) return;
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            if (promotions.length === 0) {
                container.innerHTML = `
                    <div class="admin-empty-state">
                        <div class="admin-empty-state-icon">üì¢</div>
                        <div class="admin-empty-state-text">No hay promociones registradas</div>
                        <button class="admin-button" onclick="openNewPromotionModal()">+ Agregar Promoci√≥n</button>
                    </div>
                `;
                return;
            }
            
            // Ordenar promociones por estado (activas primero) y nombre
            promotions.sort((a, b) => {
                if (a.estado !== b.estado) {
                    return a.estado === 'active' ? -1 : 1;
                }
                return a.nombre.localeCompare(b.nombre);
            });
            
            // Renderizar cada promoci√≥n
            promotions.forEach(promotion => {
                const promoCard = document.createElement('div');
                promoCard.className = 'promo-card';
                
                promoCard.innerHTML = `
                    <div class="promo-info">
                        <div class="promo-title">${promotion.nombre}</div>
                        <div class="promo-description">${promotion.descripcion || 'Sin descripci√≥n'}</div>
                        <div class="promo-discount">Descuento: ${promotion.descuento}</div>
                        <div>
                            <span class="admin-badge ${promotion.estado === 'active' ? 'admin-badge-confirmed' : 'admin-badge-canceled'}">
                                ${promotion.estado === 'active' ? 'Activa' : 'Inactiva'}
                            </span>
                        </div>
                    </div>
                    <div class="promo-actions">
                        <button class="admin-action-btn admin-action-edit" onclick="openEditPromotionModal('${promotion.id}')">‚úé</button>
                        <button class="admin-action-btn admin-action-cancel" onclick="deletePromotion('${promotion.id}')">‚úï</button>
                    </div>
                `;
                
                container.appendChild(promoCard);
            });
        }
        
        // Abrir modal para nueva promoci√≥n
        function openNewPromotionModal() {
            // Limpiar formulario
            document.getElementById('new-promotion-name').value = '';
            document.getElementById('new-promotion-description').value = '';
            document.getElementById('new-promotion-discount').value = '';
            document.getElementById('new-promotion-status').value = 'active';
            
            // Mostrar modal
            document.getElementById('new-promotion-modal').style.display = 'block';
        }
        
        // Cerrar modal de nueva promoci√≥n
        function closeNewPromotionModal() {
            document.getElementById('new-promotion-modal').style.display = 'none';
        }
        
        // Crear nueva promoci√≥n
        function createNewPromotion() {
            // Obtener datos del formulario
            const name = document.getElementById('new-promotion-name').value;
            const description = document.getElementById('new-promotion-description').value;
            const discount = document.getElementById('new-promotion-discount').value;
            const status = document.getElementById('new-promotion-status').value;
            
            // Validar datos
            if (!name) {
                alert('El nombre de la promoci√≥n es obligatorio');
                return;
            }
            
            if (!discount) {
                alert('El descuento es obligatorio');
                return;
            }
            
            // ID √∫nico
            const promotionId = 'promo_' + Date.now().toString();
            
            // Crear promoci√≥n
            const newPromotion = {
                id: promotionId,
                nombre: name,
                descripcion: description,
                descuento: discount,
                estado: status,
                fechaCreacion: new Date().toISOString()
            };
            
            // Guardar en Firestore
            db.collection('promociones').doc(promotionId)
                .set(newPromotion)
                .then(() => {
                    console.log("Promoci√≥n creada con √©xito");
                    // Cerrar modal
                    closeNewPromotionModal();
                    // Recargar promociones
                    loadPromotions();
                    // Mostrar mensaje
                    alert('Promoci√≥n creada correctamente');
                })
                .catch((error) => {
                    console.error("Error al crear la promoci√≥n: ", error);
                    alert('Error al crear la promoci√≥n. Int√©ntalo de nuevo.');
                });
        }
        
        // Abrir modal de edici√≥n de promoci√≥n
        function openEditPromotionModal(promotionId) {
            // Buscar promoci√≥n
            const promotion = promotions.find(p => p.id === promotionId);
            
            if (!promotion) {
                alert('Promoci√≥n no encontrada');
                return;
            }
            
            // Llenar formulario
            document.getElementById('edit-promotion-name').value = promotion.nombre;
            document.getElementById('edit-promotion-description').value = promotion.descripcion || '';
            document.getElementById('edit-promotion-discount').value = promotion.descuento;
            document.getElementById('edit-promotion-status').value = promotion.estado || 'active';
            
            // Guardar ID de la promoci√≥n actual
            currentPromotionId = promotionId;
            
            // Mostrar modal
            document.getElementById('edit-promotion-modal').style.display = 'block';
        }
        
        // Cerrar modal de edici√≥n de promoci√≥n
        function closeEditPromotionModal() {
            document.getElementById('edit-promotion-modal').style.display = 'none';
            currentPromotionId = null;
        }
        
        // Guardar cambios de promoci√≥n
        function savePromotionChanges() {
            // Verificar que hay una promoci√≥n seleccionada
            if (!currentPromotionId) {
                alert('No hay promoci√≥n seleccionada');
                return;
            }
            
            // Obtener datos del formulario
            const name = document.getElementById('edit-promotion-name').value;
            const description = document.getElementById('edit-promotion-description').value;
            const discount = document.getElementById('edit-promotion-discount').value;
            const status = document.getElementById('edit-promotion-status').value;
            
            // Validar datos
            if (!name) {
                alert('El nombre de la promoci√≥n es obligatorio');
                return;
            }
            
            if (!discount) {
                alert('El descuento es obligatorio');
                return;
            }
            
            // Preparar datos actualizados
            const updatedData = {
                nombre: name,
                descripcion: description,
                descuento: discount,
                estado: status,
                fechaActualizacion: new Date().toISOString()
            };
            
            // Actualizar en Firestore
            db.collection('promociones').doc(currentPromotionId)
                .update(updatedData)
                .then(() => {
                    console.log("Promoci√≥n actualizada con √©xito");
                    // Cerrar modal
                    closeEditPromotionModal();
                    // Recargar promociones
                    loadPromotions();
                    // Mostrar mensaje
                    alert('Promoci√≥n actualizada correctamente');
                })
                .catch((error) => {
                    console.error("Error al actualizar la promoci√≥n: ", error);
                    alert('Error al actualizar la promoci√≥n. Int√©ntalo de nuevo.');
                });
        }
        
        // Eliminar promoci√≥n
        function deletePromotion(promotionId) {
            // Confirmar eliminaci√≥n
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta promoci√≥n? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            // Eliminar de Firestore
            db.collection('promociones').doc(promotionId)
                .delete()
                .then(() => {
                    console.log("Promoci√≥n eliminada con √©xito");
                    // Recargar promociones
                    loadPromotions();
                    // Mostrar mensaje
                    alert('Promoci√≥n eliminada correctamente');
                })
                .catch((error) => {
                    console.error("Error al eliminar la promoci√≥n: ", error);
                    alert('Error al eliminar la promoci√≥n. Int√©ntalo de nuevo.');
                });
        }
        
        // Buscar promociones
        function searchPromotions() {
            const searchText = document.getElementById('promotions-search').value.toLowerCase();
            
            if (!searchText.trim()) {
                // Si no hay texto, mostrar todas las promociones
                renderPromotions();
                return;
            }
            
            // Filtrar promociones seg√∫n el texto de b√∫squeda
            const filteredPromotions = promotions.filter(promotion => 
                promotion.nombre.toLowerCase().includes(searchText) ||
                (promotion.descripcion && promotion.descripcion.toLowerCase().includes(searchText)) ||
                promotion.descuento.toLowerCase().includes(searchText)
            );
            
            // Actualizar contenedor con las promociones filtradas
            const container = document.getElementById('promotions-container');
            if (!container) return;
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Si no hay resultados, mostrar mensaje
            if (filteredPromotions.length === 0) {
                container.innerHTML = `
                    <div class="admin-empty-state">
                        <div class="admin-empty-state-text">No se encontraron resultados para "${searchText}"</div>
                    </div>
                `;
                return;
            }
            
            // Cargar promociones filtradas
            filteredPromotions.forEach(promotion => {
                const promoCard = document.createElement('div');
                promoCard.className = 'promo-card';
                
                promoCard.innerHTML = `
                    <div class="promo-info">
                        <div class="promo-title">${promotion.nombre}</div>
                        <div class="promo-description">${promotion.descripcion || 'Sin descripci√≥n'}</div>
                        <div class="promo-discount">Descuento: ${promotion.descuento}</div>
                        <div>
                            <span class="admin-badge ${promotion.estado === 'active' ? 'admin-badge-confirmed' : 'admin-badge-canceled'}">
                                ${promotion.estado === 'active' ? 'Activa' : 'Inactiva'}
                            </span>
                        </div>
                    </div>
                    <div class="promo-actions">
                        <button class="admin-action-btn admin-action-edit" onclick="openEditPromotionModal('${promotion.id}')">‚úé</button>
                        <button class="admin-action-btn admin-action-cancel" onclick="deletePromotion('${promotion.id}')">‚úï</button>
                    </div>
                `;
                
                container.appendChild(promoCard);
            });
        }
        
        // ===== FUNCIONES PARA GESTI√ìN DE DISPONIBILIDAD =====
        
        // Mostrar secci√≥n de disponibilidad
        function showAvailabilitySection() {
            // Ocultar tabla de citas y mostrar secci√≥n de disponibilidad
            document.querySelector('#appointments .admin-table').style.display = 'none';
            document.getElementById('availability-section').style.display = 'block';
            
            // Actualizar UI
            updateAdminMonthLabel();
            loadAvailability();
            
            // Actualizar tabs
            const tabs = document.querySelectorAll('#appointments .admin-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            tabs[4].classList.add('active'); // La tab de Disponibilidad
        }
        
        // Ocultar secci√≥n de disponibilidad
        function hideAvailabilitySection() {
            document.querySelector('#appointments .admin-table').style.display = 'table';
            document.getElementById('availability-section').style.display = 'none';
        }
        
        // Cambiar mes en administrador
        function changeAdminMonth(offset) {
            currentAdminMonth.setMonth(currentAdminMonth.getMonth() + offset);
            updateAdminMonthLabel();
            loadAvailability();
        }
        
        // Actualizar etiqueta del mes
        function updateAdminMonthLabel() {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const monthName = months[currentAdminMonth.getMonth()];
            const year = currentAdminMonth.getFullYear();
            
            document.getElementById('currentMonthLabel').textContent = `${monthName} ${year}`;
        }
        
        // Cargar disponibilidad desde Firestore
        function loadAvailability() {
            // Obtener el primer y √∫ltimo d√≠a del mes actual
            const firstDay = new Date(currentAdminMonth.getFullYear(), currentAdminMonth.getMonth(), 1);
            const lastDay = new Date(currentAdminMonth.getFullYear(), currentAdminMonth.getMonth() + 1, 0);
            
            // Consultar Firestore para obtener la disponibilidad del mes actual
            db.collection('disponibilidad')
                .where('fecha', '>=', firstDay.toISOString())
                .where('fecha', '<=', lastDay.toISOString())
                .get()
                .then((snapshot) => {
                    availableTimes = [];
                    snapshot.forEach((doc) => {
                        availableTimes.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderAvailabilityList();
                })
                .catch((error) => {
                    console.error("Error al cargar disponibilidad:", error);
                });
        }
        
        // Renderizar lista de disponibilidad
        function renderAvailabilityList() {
            const container = document.getElementById('availability-list');
            container.innerHTML = '';
            
            if (availableTimes.length === 0) {
                container.innerHTML = `
                    <div class="admin-empty-state">
                        <div class="admin-empty-state-icon">üìÖ</div>
                        <div class="admin-empty-state-text">No hay horarios disponibles para este mes</div>
                        <button class="admin-button" onclick="openNewAvailabilityModal()">+ Agregar Horario</button>
                    </div>
                `;
                return;
            }
            
            // Agrupar por d√≠a
            const dayGroups = {};
            availableTimes.forEach(slot => {
                const dateObj = new Date(slot.fecha);
                const dayKey = getDayFromDate(dateObj);
                
                if (!dayGroups[dayKey]) {
                    dayGroups[dayKey] = [];
                }
                
                dayGroups[dayKey].push(slot);
            });
            
            // Renderizar cada d√≠a con sus horarios
            Object.keys(dayGroups).sort().forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'availability-day';
                
                const slots = dayGroups[day];
                
                // Crear cabecera del d√≠a
                const dayHeader = document.createElement('div');
                dayHeader.className = 'availability-day-header';
                dayHeader.innerHTML = `
                    <div class="availability-day-date">${day}</div>
                `;
                
                // Crear contenedor de horarios
                const timesContainer = document.createElement('div');
                timesContainer.className = 'availability-times';
                
                // Ordenar slots por hora
                slots.sort((a, b) => {
                    return a.hora.localeCompare(b.hora);
                });
                
                // Agregar cada horario
                slots.forEach(slot => {
                    const timeEl = document.createElement('div');
                    timeEl.className = 'availability-time';
                    
                    let statusClass = '';
                    switch (slot.capacidad) {
                        case 'high': statusClass = 'status-high'; break;
                        case 'medium': statusClass = 'status-medium'; break;
                        case 'low': statusClass = 'status-low'; break;
                        case 'unavailable': statusClass = 'status-unavailable'; break;
                    }
                    
                    timeEl.innerHTML = `
                        <div class="availability-time-info">
                            <div class="availability-status ${statusClass}"></div>
                            <div>${slot.hora}</div>
                        </div>
                        <div class="availability-time-actions">
                            <button class="admin-action-btn admin-action-edit" onclick="openEditAvailabilityModal('${slot.id}')">‚úé</button>
                        </div>
                    `;
                    
                    timesContainer.appendChild(timeEl);
                });
                
                // Agregar elementos al d√≠a
                dayEl.appendChild(dayHeader);
                dayEl.appendChild(timesContainer);
                
                // Agregar d√≠a al contenedor principal
                container.appendChild(dayEl);
            });
        }
        
       // Abrir modal para nueva disponibilidad
function openNewAvailabilityModal() {
    // Establecer fecha actual por defecto
    const today = new Date();
    document.getElementById('new-avail-date').value = today.toISOString().split('T')[0];
    
    // Establecer hora actual redondeada a la pr√≥xima hora completa
    const currentHour = today.getHours();
    const period = currentHour >= 12 ? "PM" : "AM";
    let hour = currentHour % 12;
    if (hour === 0) hour = 12;
    
    // Seleccionar los valores por defecto
    document.getElementById('new-avail-hour').value = hour;
    document.getElementById('new-avail-minute').value = "00";
    document.getElementById('new-avail-period').value = period;
    document.getElementById('new-avail-capacity').value = 'high';
    
    // Mostrar modal
    document.getElementById('new-availability-modal').style.display = 'block';
}
        // Cerrar modal de nueva disponibilidad
        function closeNewAvailabilityModal() {
            document.getElementById('new-availability-modal').style.display = 'none';
        }
        
   // Crear nueva disponibilidad
function createNewAvailability() {
    // Obtener datos del formulario
    const dateInput = document.getElementById('new-avail-date').value;
    const hour = document.getElementById('new-avail-hour').value;
    const minute = document.getElementById('new-avail-minute').value;
    const period = document.getElementById('new-avail-period').value;
    const capacity = document.getElementById('new-avail-capacity').value;
    
    // Validar
    if (!dateInput) {
        alert('Por favor, selecciona una fecha');
        return;
    }
    
    // Formatear la hora en formato 12h con AM/PM
    const formattedTime = `${hour}:${minute} ${period}`;
    
    // Obtener el d√≠a formateado
    const day = getDayFromDate(dateInput);
    
    // ID √∫nico
    const availabilityId = 'avail_' + Date.now().toString();
    
    // Crear objeto de disponibilidad
    const availabilityData = {
        id: availabilityId,
        fecha: dateInput,
        dia: day,
        hora: formattedTime,
        capacidad: capacity,
        fechaCreacion: new Date().toISOString()
    };
    
    // Log del objeto a guardar
    console.log("Datos a guardar:", availabilityData);
    
    // Guardar en Firestore
    db.collection('disponibilidad').doc(availabilityId)
        .set(availabilityData)
        .then(() => {
            console.log("Horario creado con √©xito");
            // Cerrar modal
            closeNewAvailabilityModal();
            // Recargar disponibilidad
            loadAvailability();
            // Mostrar mensaje
            alert('Horario creado correctamente');
        })
        .catch((error) => {
            console.error("Error al crear horario:", error);
            alert('Error al crear horario. Int√©ntalo de nuevo.');
        });
}

// Funci√≥n para convertir formato de hora de 24h a 12h con AM/PM
function formatTimeTo12Hour(time24h) {
    // Verificar si ya tiene formato AM/PM
    if (time24h.includes('AM') || time24h.includes('PM')) {
        return time24h;
    }
    
    const [hours, minutes] = time24h.split(':');
    let period = 'AM';
    let hour = parseInt(hours);
    
    if (hour >= 12) {
        period = 'PM';
        if (hour > 12) {
            hour -= 12;
        }
    }
    
    if (hour === 0) {
        hour = 12;
    }
    
    return `${hour}:${minutes} ${period}`;
}
        // Funci√≥n para convertir fecha a formato "Lunes 1 Mayo"
function getDayFromDate(dateString) {
    let date;
    
    if (typeof dateString === 'string' && dateString.includes('-')) {
        // Si es una cadena de formato YYYY-MM-DD (desde input date)
        const parts = dateString.split('-');
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1; // Meses en JS son 0-indexed
        const day = parseInt(parts[2]);
        
        // Crear fecha espec√≠ficamente con estos valores y tiempo a mediod√≠a
        // para evitar problemas de zona horaria
        date = new Date(year, month, day, 12, 0, 0);
    } else {
        // Si ya es un objeto Date u otro formato
        date = new Date(dateString);
    }
    
    const weekdays = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    
    const weekday = weekdays[date.getDay()];
    const dayOfMonth = date.getDate();
    const monthName = months[date.getMonth()];
    
    return `${weekday} ${dayOfMonth} ${monthName}`;
}
        
        // Abrir modal para editar disponibilidad
        function openEditAvailabilityModal(availabilityId) {
            // Buscar la disponibilidad
            const availability = availableTimes.find(a => a.id === availabilityId);
            
            if (!availability) {
                alert('Horario no encontrado');
                return;
            }
            
            // Llenar formulario
            document.getElementById('edit-avail-date').value = availability.dia;
            document.getElementById('edit-avail-time').value = availability.hora;
            document.getElementById('edit-avail-capacity').value = availability.capacidad;
            
            // Guardar ID actual
            currentAvailabilityId = availabilityId;
            
            // Mostrar modal
            document.getElementById('edit-availability-modal').style.display = 'block';
        }
        
        // Cerrar modal de editar disponibilidad
        function closeEditAvailabilityModal() {
            document.getElementById('edit-availability-modal').style.display = 'none';
            currentAvailabilityId = null;
        }
        
        // Guardar cambios de disponibilidad
        function saveAvailabilityChanges() {
            // Verificar que hay una disponibilidad seleccionada
            if (!currentAvailabilityId) {
                alert('No hay horario seleccionado');
                return;
            }
            
            // Obtener datos del formulario
            const capacity = document.getElementById('edit-avail-capacity').value;
            
            // Buscar la disponibilidad actual para obtener d√≠a y hora
            const availability = availableTimes.find(a => a.id === currentAvailabilityId);
            
            // Verificar
            if (!availability) {
                alert('Horario no encontrado');
                return;
            }
            
            // Preparar datos actualizados
            const updatedData = {
                capacidad: capacity,
                fechaActualizacion: new Date().toISOString()
            };
            
            // Actualizar en Firestore
            db.collection('disponibilidad').doc(currentAvailabilityId)
                .update(updatedData)
                .then(() => {
                    console.log("Horario actualizado con √©xito");
                    // Cerrar modal
                    closeEditAvailabilityModal();
                    // Recargar disponibilidad
                    loadAvailability();
                    // Mostrar mensaje
                    alert('Horario actualizado correctamente');
                    
                    // Actualizar tambi√©n la p√°gina principal
                    updateHomepageAvailability(availability.dia, availability.hora, capacity);
                })
                .catch((error) => {
                    console.error("Error al actualizar horario:", error);
                    alert('Error al actualizar horario. Int√©ntalo de nuevo.');
                });
        }
        
        
        // Eliminar disponibilidad
        function deleteAvailability() {
            // Verificar que hay una disponibilidad seleccionada
            if (!currentAvailabilityId) {
                alert('No hay horario seleccionado');
                return;
            }
            
            // Confirmar
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este horario?')) {
                return;
            }
            
            // Buscar la disponibilidad actual para obtener d√≠a y hora
            const availability = availableTimes.find(a => a.id === currentAvailabilityId);
            
            // Eliminar de Firestore
            db.collection('disponibilidad').doc(currentAvailabilityId)
                .delete()
                .then(() => {
                    console.log("Horario eliminado con √©xito");
                    // Cerrar modal
                    closeEditAvailabilityModal();
                    // Recargar disponibilidad
                    loadAvailability();
                    // Mostrar mensaje
                    alert('Horario eliminado correctamente');
                    
                    // Actualizar tambi√©n la p√°gina principal si hay disponibilidad
                    if (availability) {
                        updateHomepageAvailability(availability.dia, availability.hora, 'unavailable');
                    }
                })
                .catch((error) => {
                    console.error("Error al eliminar horario:", error);
                    alert('Error al eliminar horario. Int√©ntalo de nuevo.');
                });
        }
        
        // Actualizar disponibilidad en la p√°gina principal
        // Esta funci√≥n ser√≠a ideal si tuvi√©ramos una base de datos en tiempo real,
        // pero como estamos usando Firestore, los cambios se reflejar√°n al recargar la p√°gina
        function updateHomepageAvailability(day, time, capacity) {
            console.log(`Actualizado en la p√°gina principal: D√≠a ${day}, Hora ${time}, Capacidad ${capacity}`);
            // Aqu√≠ se podr√≠a implementar una actualizaci√≥n en tiempo real 
            // a trav√©s de sockets o mensajer√≠a si se requiere
        }
        
        // ===== FUNCIONES PARA CONFIGURACI√ìN =====
        
        // Inicializar funcionalidad de configuraci√≥n
        function initSettings() {
            // Inicializar previsualizaci√≥n de colores
            const primaryColorInput = document.getElementById('settings-primary-color');
            const secondaryColorInput = document.getElementById('settings-secondary-color');
            
            if (primaryColorInput) {
                primaryColorInput.addEventListener('input', updateColorPreviews);
            }
            
            if (secondaryColorInput) {
                secondaryColorInput.addEventListener('input', updateColorPreviews);
            }
        }
        
        // Cargar configuraci√≥n
        function loadSettings() {
            db.collection('configuracion').doc('settings')
                .get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // Llenar campos del formulario
                        document.getElementById('settings-name').value = data.nombre || 'MG STUDIO';
                        document.getElementById('settings-address').value = data.direccion || 'Jr. Bolognesi 265';
                        document.getElementById('settings-phone').value = data.telefono || '995 904 351';
                        document.getElementById('settings-instagram').value = data.instagram || 'https://www.instagram.com/mg.studio_pe';
                        
                        // Colores
                        document.getElementById('settings-primary-color').value = data.colorPrimario || '#ff4b7d';
                        document.getElementById('settings-secondary-color').value = data.colorSecundario || '#333333';
                        
                        // Actualizar previsualizaciones
                        updateColorPreviews();
                    }
                })
                .catch((error) => {
                    console.error("Error al cargar configuraci√≥n:", error);
                });
        }
        
        // Actualizar previsualizaciones de color
        function updateColorPreviews() {
            const primaryColor = document.getElementById('settings-primary-color').value;
            const secondaryColor = document.getElementById('settings-secondary-color').value;
            
            // Actualizar previsualizaciones
            document.getElementById('primaryColorPreview').style.backgroundColor = primaryColor;
            document.getElementById('secondaryColorPreview').style.backgroundColor = secondaryColor;
        }
        
        // Guardar configuraci√≥n
        function saveSettings() {
            // Obtener datos del formulario
            const name = document.getElementById('settings-name').value;
            const address = document.getElementById('settings-address').value;
            const phone = document.getElementById('settings-phone').value;
            const instagram = document.getElementById('settings-instagram').value;
            const primaryColor = document.getElementById('settings-primary-color').value;
            const secondaryColor = document.getElementById('settings-secondary-color').value;
            
            // Validar datos
            if (!name) {
                alert('El nombre del estudio es obligatorio');
                return;
            }
            
            // Preparar datos
            const settingsData = {
                nombre: name,
                direccion: address,
                telefono: phone,
                instagram: instagram,
                colorPrimario: primaryColor,
                colorSecundario: secondaryColor,
                fechaActualizacion: new Date().toISOString()
            };
            
            // Guardar en Firestore
            db.collection('configuracion').doc('settings')
                .set(settingsData, { merge: true })
                .then(() => {
                    console.log("Configuraci√≥n guardada con √©xito");
                    alert('Configuraci√≥n guardada correctamente');
                })
                .catch((error) => {
                    console.error("Error al guardar configuraci√≥n:", error);
                    alert('Error al guardar configuraci√≥n. Int√©ntalo de nuevo.');
                });
        }
    </script>
</body>
</html>
                    
